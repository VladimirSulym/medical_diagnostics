<div class="row py-5">
    <h2 class="text-center mb-4 text-primary">Оставить отзыв</h2>
    <div class="col-md-8 mx-auto">
        <form method="post">
            {% csrf_token %}

            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}

            {% if messages %}
                <div class="messages">
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="mb-3">
                <label for="author" class="form-label">Автор</label>
                <input type="text" class="form-control" id="author" name="author"
                       value="{{ user.get_full_name }}"
                       readonly>
            </div>

            <div class="mb-3 form-check">
                {{ form.is_anonymous }}
                <label class="form-check-label" for="{{ form.is_anonymous.id_for_label }}">
                    Оставить отзыв анонимно
                </label>
            </div>

            <div class="mb-3">

                <select class="form-select {% if form.doctor.errors %}is-invalid{% endif %}" id="doctor"
                        name="doctor">
                    <option value="">Выберите врача</option>
                    {% for doctor in form.doctor.field.queryset %}
                        <option value="{{ doctor.id }}">{{ doctor }}</option>
                    {% endfor %}
                </select>
                {% if form.doctor.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.doctor.errors }}
                    </div>
                {% endif %}

                <div class="mt-2">
                    <label class="form-label">Оценка врача</label>
                    <div class="rating">
                        {% for i in "54321"|make_list %}
                            <input type="radio" name="doctor_rating" value="{{ i }}"
                                   id="doctor_{{ i }}"
                                   onclick="handleRatingClick(this)">
                            <label for="doctor_{{ i }}"><i class="bi bi-star-fill"></i></label>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label for="department" class="form-label">Выберите отделение</label>
                <select class="form-select" id="department" name="department_id">
                    <option value="">Выберите отделение</option>
                    {% for department in departments %}
                        <option value="{{ department.id }}">{{ department.name }}</option>
                    {% endfor %}
                </select>
            </div>


            <div class="mb-3">
                <label for="{{ form.service.id_for_label }}" id="service_label" class="form-label">Выберите
                    услугу</label>
                <select class="form-select {% if form.service.errors %}is-invalid{% endif %}" id="service"
                        name="service" disabled>
                    <option value="">Сначала выберите отделение</option>
                </select>
                {% if form.service.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.service.errors }}
                    </div>
                {% endif %}


                <div class="mt-2">
                    <label class="form-label">Оценка услуги</label>
                    <div class="rating">
                        {% for i in "54321"|make_list %}
                            <input type="radio" name="service_rating" value="{{ i }}" id="service_{{ i }}"
                                   onclick="handleRatingClick(this)">
                            <label for="service_{{ i }}"><i class="bi bi-star-fill"></i></label>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label for="{{ form.text.id_for_label }}" class="form-label">Текст отзыва:</label>
                {{ form.text }}
                {% if form.text.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.text.errors }}
                    </div>
                {% endif %}
            </div>

            <button type="submit" class="btn btn-primary">Отправить отзыв</button>
        </form>
    </div>
</div>

<script>
    document.getElementById('department').addEventListener('change', function () {
        const departmentId = this.value;
        const serviceSelect = document.getElementById('service');
        serviceSelect.disabled = !departmentId;

        if (departmentId) {
            serviceSelect.innerHTML = '<option value="">Выберите услугу</option>';
            {% for service in form.service.field.queryset%}
                if ('{{ service.department.id }}' === departmentId) {
                    serviceSelect.innerHTML += `<option value="{{ service.id }}">{{ service.name }}</option>`;
                }
            {% endfor %}
        } else {
            serviceSelect.innerHTML = '<option value="">Сначала выберите отделение</option>';
        }
    });

    function handleRatingClick(radio) {
        if (radio.classList.contains('clicked')) {
            radio.checked = false;
            radio.classList.remove('clicked');
        } else {
            let name = radio.name;
            document.querySelectorAll(`input[name="${name}"]`).forEach(r => r.classList.remove('clicked'));
            radio.classList.add('clicked');
        }
    }

    function toggleAuthor() {
        const authorInput = document.getElementById('author');
        const anonymous = document.getElementById('anonymous');

        if (anonymous.checked) {
            authorInput.value = "Анонимно";
            authorInput.disabled = true;
        } else {
            authorInput.value = "{{ user.get_full_name }}";
            authorInput.disabled = false;
        }
    }
</script>


